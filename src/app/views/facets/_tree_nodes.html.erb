<% colors ||= {} %>
<% facet_model = Facet.find(category) %>
<% param_key = facet_model&.param_key %>
<% nodes.each do |node| %>
  <% node_dom_id = safe_dom_id(node[:id]) %>
  <% unique_suffix = SecureRandom.hex(4) %>
  <% node_instance_id = "#{node_dom_id}_#{unique_suffix}" %>
  <% checkbox_id = "#{category}_#{node_instance_id}" %>
  <% is_selected = Array(params[param_key]).include?(node[:id].to_s) %>
  <div class="tree-node"
       data-facet-tree-target="treeNode"
       data-node-id="<%= node[:id] %>"
       data-label="<%= node[:name] %>"
       <%= 'data-has-selected-children="true"' if node[:has_selected_children] %>
       style="<%= level > 0 ? "margin-left: #{level * 0.75}rem;" : "" %>">
    <div class="flex items-center py-1 px-1 rounded hover:bg-gray-50 group transition-colors">
      <% if node[:has_children] %>
        <% is_expanded = node[:has_selected_children] %>
        <button type="button"
                class="w-4 h-4 p-0 mr-1.5 text-gray-400 hover:text-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-0 <%= colors[:focus_ring] %> rounded flex items-center justify-center"
                data-action="click->facet-tree#toggleNode"
                data-node-id="<%= node[:id] %>"
                data-tree-frame-id="facet_nodes_<%= category %>_<%= node_instance_id %>">
          <svg class="w-3 h-3 transition-transform duration-150"
               data-facet-tree-target="nodeChevron"
               style="<%= is_expanded ? 'transform: rotate(90deg);' : '' %>"
               fill="currentColor"
               viewBox="0 0 20 20">
            <path fill-rule="evenodd"
                  d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                  clip-rule="evenodd" />
          </svg>
        </button>
      <% else %>
        <span class="w-4 h-4 mr-1.5 inline-block"></span>
      <% end %>
      <input type="checkbox"
             id="<%= checkbox_id %>"
             name="<%= param_key %>[]"
             value="<%= node[:id] %>"
             form="search_form"
             class="mr-2 h-4 w-4 <%= colors[:checkbox_checked] %> border-gray-300 rounded focus:ring-2 <%= colors[:focus_ring] %> focus:ring-offset-0"
             data-action="change->facet-tree#handleSelection"
             <%= 'checked' if is_selected %>>
      <label for="<%= checkbox_id %>"
             class="flex-1 truncate text-sm text-gray-700 cursor-pointer select-none group-hover:text-gray-900 pr-2"
             title="<%= node[:name] %>">
        <%= node[:name] %>
      </label>
      <span id="count_<%= category %>_<%= node[:id].to_s.parameterize %>_<%= unique_suffix %>"
            class="ml-auto px-1.5 py-0.5 text-xs font-medium bg-gray-100 text-gray-600 rounded group-hover:bg-gray-200 whitespace-nowrap">
        <%= number_with_delimiter(node[:count]) %>
      </span>
    </div>
    <% if node[:has_children] %>
      <% should_auto_expand = node[:has_selected_children] %>
      <% frame_id = "facet_nodes_#{category}_#{node_instance_id}" %>
      <div class="<%= should_auto_expand ? '' : 'hidden' %>"
           data-facet-tree-target="childrenContainer"
           data-parent-id="<%= node[:id] %>">
        <turbo-frame id="<%= frame_id %>"
                     data-loaded="false"
                     src="<%= facet_children_path(category: category, parent_id: node[:id], frame_id: frame_id, **facet_params) %>"
                     loading="<%= should_auto_expand ? 'eager' : 'lazy' %>">
          <%= render "shared/skeleton_loader" %>
        </turbo-frame>
      </div>
    <% end %>
  </div>
<% end %>
